<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1"><meta name="author" content="Aeolia"><meta name="description" content="just a blog now."><title>Chrome下的迅雷扩展实现整理(旧文迁移) | Aeolia'Space</title><link href="/favicon.ico" rel="icon"><link rel="stylesheet" media="screen" href="/style/typo.css"><link rel="stylesheet" media="screen" href="/style/highlight.css"><link rel="stylesheet" media="screen" href="/style/index.css"></head><body><div id="header"><h1 class="title"><a id="logo" href="https://suprise.github.io/blog_hexo/"> Aeolia'Space</a></h1><ul class="nav"><li><a href="/categories/tech">技术</a></li><li class="sep"></li><li><a href="/categories/weeksum">周记</a></li><li class="sep"></li><li><a href="/categories/hobby">爱好</a></li><li class="sep"></li><li><a href="/categories/life">随笔</a></li><li class="sep"></li><li><a href="#" class="switchDataRain opening">关闭动画</a></li></ul></div><div id="article-con"><div id="search-con"><form action="https://www.baidu.com/s" method="get" accept-charset="utf-8"><input type="text" name="q1" placeholder="Search" class="search-input"><input type="hidden" name="q6" value="github.com"></form></div><article thread="/blog/2013/08/04/thunder-chrome-extension/" class="meta"><div class="inner"><a href="/2013/08/04/thunder-chrome-extension/"><h2 class="title">Chrome下的迅雷扩展实现整理(旧文迁移)</h2></a><div class="meta"><span>&nbsp;by&nbsp;</span>Aeolia<span>&nbsp;on&nbsp;</span>2013年8月4日</div><div class="text"><p>自从前段时间原先用的迅雷下载扩展被新的运营团队添加了它们自己的页面导航以后，有以下几点非常不爽（虽然它们的界面仿三星操作系统感觉还行）</p>
<ol>
<li>没有经过用户的允许</li>
<li>没有页面的统计排序</li>
<li>每项之间空隙过小，眼睛不容易识别，比较累</li>
<li>需要手动添加网址记录而不是自动记录</li>
<li>喵的我的MIKU 主题被覆盖了!</li>
</ol>
<p>而该迅雷扩展好用在遇到资源可以（右键-&gt;迅雷下载）并自动启动迅雷，从而省去了我（开始菜单—&gt;找寻+鼠标移动—&gt;迅雷软件—&gt;找寻+鼠标移动—&gt;启动迅雷）的这么一个繁琐的操作，所以写一个还是很必要的。</p>
<p>第一天，白天玩，吃过晚饭后，我先大致了解一下迅雷链接的<a href="http://zhainan.org/post-914.html" target="_blank" rel="external">转换原理</a>，然后开始学习Base64编码，最后用JS以类的形式将其实现。<br>之所以选择类的方式而不是对象的方式来实现，是因为编码和解码函数要共用一个hash_map，而这一个共有hash_map只能是私有变量，如果对象要实现私有变量只能用闭包的方式，所以会导致冗余。</p>
<p><a href="http://zh.wikipedia.org/wiki/Base64" target="_blank" rel="external">Base64</a>是一种常用于邮件的编码，可逆，所以只是防君子不防小人。</p>
<h4 id="编码："><em>编码：</em></h4><ol>
<li><p>选取3个字节，总共24位，看成4个6位的数据，在每个6位的数据前面补充0，最后获得4个字节，转换为十进制数字。补充位和去除位采用位与、位或等操作。若最后不足3个字节，则用0补足。<br> 补充一下，因为chrome对JS的位操作是转换成C然后编译实现的，速度很快——《高性能Javascript》</p>
<p> <strong>例</strong>，常见的htt的十进制码为104,116,116。<br> 二进制码为 01101000,01110100,01110100<br> 分成四个6位的数据 011010,000111,010001,110100<br> 补充0 00011010,00000111,00010001,00110100<br> 转换为十进制 26,7,17,52</p>
</li>
<li>根据表转换为对应的数值<br><img src="http://chen-xi-se.com/wp-content/uploads/2013/08/Base64-%E7%BB%B4%E5%9F%BA%E7%99%BE%E7%A7%91%EF%BC%8C%E8%87%AA%E7%94%B1%E7%9A%84%E7%99%BE%E7%A7%91%E5%85%A8%E4%B9%A6-285x300.png" alt="base64转换表"><br> <strong>例</strong>，上一步得到的26,7,17,52分别转换为a,H,R,0，然后连起来就变成aHR0了</li>
<li>收尾，如果最后不足3个字节，则差X个字节，就在链接后补X个=字符。同时，根据<a href="http://tools.ietf.org/html/rfc1421" target="_blank" rel="external">RFC1421</a>，每76个字节则换一行（需要注意，网上找的实现方式很可能漏了这一点）</li>
</ol>
<p>解码则是逆操作即可。</p>
<p>开始看<a href="http://code.google.com/chrome/extensions/getstarted.html" target="_blank" rel="external">Chrome扩展文档</a>，也有<a href="http://www.lmk123.com/docs/getstarted.html" target="_blank" rel="external">中文版</a>的，通过demo大致了解<a href="http://www.lmk123.com/docs/contextMenus.html" target="_blank" rel="external">右键菜单的API</a>使用方法和对background的使用范围进行了测试，对程序进行了大致的设计。</p>
<p>编写简单的右键菜单demo，然后对chrome如何触发外部协议请求进行研究（即chrome如何调用本地程序并将转换好的迅雷链接传递过去）。看了一晚上的文档，都没找到合适的方法，唯一一种文档中记录的方法是通过<a href="http://www.lmk123.com/docs/npapi.html" target="_blank" rel="external">NPAPI</a>机制调用本地的dll文件（官方扩展应该就是通过这种方式实现的），但这种商业软件几乎不可能不加壳，就算不加壳，没有文档的话找起API来也是非常麻烦的事情，所以这种方法暂时PASS掉。</p>
<p>灵机一动，将某一个页面的a标签的链接改为”thunder://Q”，然后点击，发现可以触发外部协议请求。银瓶乍破水浆迸，铁骑突出刀枪鸣，点击菜单——获得URL——转换为源URL——转换为迅雷专用链——生成a标签——设置a标签——生成鼠标事件——初始化点击事件——触发点击事件！非常符合逻辑的结构！结果，当然是失败，使用<a href="http://www.lmk123.com/docs/background_pages.html" target="_blank" rel="external">background</a>来执行js的话相当于在沙箱中执行，无法还原页面中js的效果。看来必须得使用content_scripts了，快两点了，收工睡觉。</p>
<p>开始详细看content_scripts的文档，尝试将上述转换为迅雷专用链以后的过程放在<a href="http://www.lmk123.com/docs/content_scripts.html" target="_blank" rel="external">content_scripts</a>里实现，并通过<a href="http://www.lmk123.com/docs/content_scripts.html#pi" target="_blank" rel="external">插入代码</a>机制，实现了上述过程。结果，虽然基本实现了功能，但在测试时发现了一个致命的bug——点击，然后触发外部协议请求确认框的时候，如果选择取消，则到本页面刷新/跳转为止，再次点击不会触发这一外部协议请求！<br>比如可以用chrome控制台执行如下代码。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="built_in">document</span>.createElement(<span class="string">"a"</span>),</span><br><span class="line">event =<span class="built_in">document</span>.createEvent(<span class="string">"MouseEvents"</span>);</span><br><span class="line">a.href=<span class="string">"thunder://QE"</span>;</span><br><span class="line">event.initEvent(<span class="string">"click"</span>,<span class="literal">true</span>,<span class="literal">true</span>,<span class="built_in">document</span>.defaultView,</span><br><span class="line"><span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="number">0</span>,<span class="literal">null</span>);</span><br><span class="line">a.dispatchEvent(event);</span><br></pre></td></tr></table></figure></p>
<p>会发现如果确认框选择“取消程序启动”的话，会导致再次执行这些代码的时候不会触发外部协议请求。</p>
<p>最后得到原作者的指导，解决了这一问题（不过牺牲了部分性能），详情见<a href="">源代码</a></p>
</div><div class="meta tags"><span>&nbsp;tagged:&nbsp;</span><a href="/tags/Base64/" class="tag">Base64</a><a href="/tags/Chrome扩展/" class="tag">Chrome扩展</a></div><hr><div id="duoshuo" data-url="https://suprise.github.io/blog_hexo/2013/08/04/thunder-chrome-extension/" data-thread-key="/blog/2013/08/04/thunder-chrome-extension/" data-title="Chrome下的迅雷扩展实现整理(旧文迁移)" class="ds-thread"></div><script type="text/javascript">var duoshuoQuery = {short_name:'suprise'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();</script></div></article></div><nav id="pagination"></nav><div id="footer" class="clearfix"><section class="archives col"><h4>归档</h4><div class="links-con"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">2015年4月</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/03/">2014年3月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/10/">2013年10月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/08/">2013年8月</a><span class="archive-list-count">1</span></li></ul></div></section><section class="tag-cloud col"><h4>标签云</h4><div class="links-con"></div><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Base64/">Base64</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Chrome扩展/">Chrome扩展</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JS/">JS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/伪元素/">伪元素</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/伪类/">伪类</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/周记/">周记</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/生活/">生活</a><span class="tag-list-count">1</span></li></ul></section><section class="friends col"><h4>友情链接</h4><li><a href="http://lingyu.wang"> 天镶</a></li></section></div><div class="copy-right clearfix">Test By Aeolia <span>&nbsp;|&nbsp;</span>Powered By <a href="http://zespia.tw/hexo">HEXO</a><span>&nbsp;|&nbsp;</span>SealScript Theme By <a href="lyric.im">Lyric Wai</a></div><script type="text/javascript" src="http://cdn.staticfile.org/jquery/2.1.1-rc2/jquery.min.js"></script><script type="text/javascript" src="/script/burn.js"></script><script type="text/javascript" src="/script/highlight.js"></script><script type="text/javascript" src="/script/data-rain.js"></script><script type="text/javascript">$(function () {
	hljs.configure({tabReplace: '    '});
	hljs.initHighlightingOnLoad();
	var burning_words = new PonticStar.BurningWords;
	burning_words.show("Aeolia's Matrix", "00FF00", "Times New Roman", 30, "000000", 100, "slow",'logo');
	//- $(document.body).bind('selectstart',function (event) {
	//- 	if (event.target.nodeName.toLowerCase() !== 'pre') {
	//- 		return false;
	//- 	}
	//- });

	new dataRain();
});</script></body></html>